---
phase: 02-railway-setup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: []
autonomous: false

user_setup:
  - service: neon
    why: "Database connection for the application"
    env_vars:
      - name: DATABASE_URL
        source: "Neon Dashboard -> Project -> Connection Details -> Connection string (with ?sslmode=require)"

must_haves:
  truths:
    - "Railway project exists and is connected to GitHub repository"
    - "All required environment variables are configured in Railway"
    - "Application builds successfully on Railway"
    - "Application is accessible via public Railway URL"
    - "Health endpoint /api/health responds with 200 OK"
  artifacts:
    - path: "Railway project: duo-connecte"
      provides: "Deployment platform"
    - path: "Railway environment variables"
      provides: "DATABASE_URL, JWT_SECRET, CIRCLE_ORIGIN, NODE_ENV configured"
  key_links:
    - from: "Railway service"
      to: "GitHub repository"
      via: "GitHub autodeploy connection"
    - from: "Railway app"
      to: "Neon PostgreSQL"
      via: "DATABASE_URL environment variable"
---

<objective>
Deploy Duo-Connecte application to Railway platform using Railway CLI.

Purpose: Complete the migration from Replit by deploying to Railway, enabling the application to be accessible on a production platform with proper environment configuration.

Output: Running Railway deployment accessible via public HTTPS URL, with all environment variables configured and health endpoint responding.
</objective>

<execution_context>
@/root/.claude/get-shit-done/workflows/execute-plan.md
@/root/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-railway-setup/02-RESEARCH.md
@.planning/phases/01-code-cleanup/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Railway project and link GitHub</name>
  <files>None (Railway platform configuration)</files>
  <action>
Using Railway CLI (already authenticated as delormeyannick@hotmail.com):

1. Create a new Railway project:
   ```bash
   railway init --name duo-connecte
   ```

2. Link the current directory to the Railway project:
   ```bash
   railway link
   ```
   (Select the duo-connecte project if prompted)

3. Connect the GitHub repository for autodeploys:
   ```bash
   railway service
   ```
   This creates a service in the project.

4. Verify the project was created:
   ```bash
   railway status
   ```

Note: If project already exists, use `railway link` to connect to it instead of `railway init`.
  </action>
  <verify>
`railway status` shows project name and service, no errors.
  </verify>
  <done>
Railway project "duo-connecte" exists and is linked to current directory.
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: Provide DATABASE_URL from Neon</name>
  <action>
User must provide the Neon PostgreSQL connection string. Claude cannot access external dashboards.
  </action>
  <instructions>
Please provide the DATABASE_URL from your Neon dashboard:

1. Go to Neon Dashboard (https://console.neon.tech)
2. Select your project
3. Click "Connection Details"
4. Copy the connection string (should look like):
   `postgresql://user:password@ep-xxx.region.neon.tech/dbname?sslmode=require`

**Important:** Make sure it includes `?sslmode=require` at the end.

Paste the DATABASE_URL here to continue.
  </instructions>
  <resume-signal>Paste DATABASE_URL connection string</resume-signal>
</task>

<task type="auto">
  <name>Task 3: Configure environment variables and deploy</name>
  <files>None (Railway platform configuration)</files>
  <action>
Using Railway CLI, set all required environment variables and trigger deployment:

1. Generate a secure JWT_SECRET (32+ characters):
   ```bash
   JWT_SECRET=$(openssl rand -base64 32)
   echo "Generated JWT_SECRET: $JWT_SECRET"
   ```

2. Set all environment variables in Railway:
   ```bash
   railway variables set DATABASE_URL="[value from Task 2]"
   railway variables set JWT_SECRET="$JWT_SECRET"
   railway variables set CIRCLE_ORIGIN="https://communaute.avancersimplement.com"
   railway variables set NODE_ENV="production"
   ```

3. Deploy to Railway:
   ```bash
   railway up
   ```
   This triggers a build and deployment. Wait for completion (1-2 minutes).

4. Generate a public domain:
   ```bash
   railway domain
   ```
   This creates a public URL like `duo-connecte-production.up.railway.app`

5. Get the deployment URL:
   ```bash
   railway status
   ```
   Note the URL for verification.
  </action>
  <verify>
- `railway variables` shows all 4 variables configured
- `railway status` shows deployment status as "deployed" or "running"
- `railway domain` shows a public URL
  </verify>
  <done>
All environment variables are set, deployment completed, public domain is generated.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 4: Verify deployment is accessible</name>
  <what-built>
Railway deployment with all environment variables configured and public domain generated.
  </what-built>
  <how-to-verify>
1. Get the Railway public URL from `railway status` or `railway domain`
2. Open the URL in a browser (e.g., https://duo-connecte-production.up.railway.app)
3. Verify the page loads without errors
4. Check the health endpoint: Visit `{URL}/api/health`
   - Expected: JSON response with status "ok" or similar
5. Check Railway logs for any startup errors:
   ```bash
   railway logs
   ```

**Expected behavior:**
- Homepage loads (may show Circle.so integration warning if not in iframe, that's OK)
- /api/health returns 200 OK
- No crash errors in logs
  </how-to-verify>
  <resume-signal>Type "approved" if deployment works, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
Run these commands to verify Phase 2 completion:

```bash
# Check Railway project status
railway status

# Check environment variables are set
railway variables

# Check deployment is live
railway domain

# Check health endpoint (replace URL with actual)
curl -s https://[your-domain].up.railway.app/api/health
```

All commands should succeed and health endpoint should return 200 OK.
</verification>

<success_criteria>
1. Railway project exists with name "duo-connecte"
2. GitHub repository connected for autodeploys (if available, or manual deploy completed)
3. Environment variables configured: DATABASE_URL, JWT_SECRET, CIRCLE_ORIGIN, NODE_ENV
4. Public domain generated and accessible
5. Health endpoint /api/health responds with 200 OK
6. Application homepage loads without server errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-railway-setup/02-01-SUMMARY.md`
</output>
