---
phase: 03-documentation-data
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - client/src/contexts/AccessContext.tsx
  - client/src/contexts/SessionContext.tsx
  - server/middleware.ts
  - server/storage.ts
  - shared/schema.ts
autonomous: true

must_haves:
  truths:
    - "AccessContext.tsx has JSDoc explaining Circle.so postMessage flow"
    - "middleware.ts has JSDoc explaining auth functions"
    - "schema.ts has comments explaining each table's purpose"
  artifacts:
    - path: "client/src/contexts/AccessContext.tsx"
      provides: "Documented Circle.so auth context"
      contains: ["/**", "@param", "postMessage"]
    - path: "server/middleware.ts"
      provides: "Documented auth middleware"
      contains: ["/**", "requireAuth", "requireAdmin"]
    - path: "shared/schema.ts"
      provides: "Documented database schema"
      contains: ["/**", "Users table", "Login attempts"]
  key_links: []
---

<objective>
Add JSDoc comments to key source files explaining their purpose and usage.

Purpose: Developers (and AI assistants) need inline documentation to understand complex code.
Output: JSDoc comments in 5 key files covering auth flow, middleware, and database schema.
</objective>

<execution_context>
@/root/.claude/get-shit-done/workflows/execute-plan.md
@/root/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-documentation-data/03-RESEARCH.md
@client/src/contexts/AccessContext.tsx
@client/src/contexts/SessionContext.tsx
@server/middleware.ts
@server/storage.ts
@shared/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add JSDoc to contexts and middleware</name>
  <files>
    client/src/contexts/AccessContext.tsx
    client/src/contexts/SessionContext.tsx
    server/middleware.ts
  </files>
  <action>
Add JSDoc comments to the following files. DO NOT rewrite the files - only ADD comments.

**client/src/contexts/AccessContext.tsx:**

1. Add file-level comment at top:
```typescript
/**
 * AccessContext - Circle.so Authentication Provider
 *
 * This context handles the authentication flow for Circle.so iframe apps:
 * 1. Receives user data from Circle.so via postMessage
 * 2. Validates the user data structure
 * 3. Syncs user with backend database
 * 4. Manages access states (loading, authenticated, needs_pin, paywall)
 *
 * The Circle.so iframe sends a CIRCLE_USER_AUTH message containing:
 * - user.email: User's email from Circle
 * - user.publicUid: Circle's unique identifier
 * - user.name: Display name
 * - user.isAdmin: Whether user is community admin
 *
 * @see ARCHITECTURE.md for full authentication flow diagram
 */
```

2. Add JSDoc to key functions:
- `validateUserData`: Explain it validates Circle.so postMessage data
- `handlePostMessage`: Explain the message event listener
- `AccessProvider`: Explain it wraps app with auth state

**client/src/contexts/SessionContext.tsx:**

1. Add file-level comment:
```typescript
/**
 * SessionContext - User Session State Management
 *
 * Manages lightweight session state for the authenticated user.
 * This is a simplified context for template purposes.
 *
 * State includes:
 * - currentStep: Progress tracking (generic counter)
 * - lastUpdated: Timestamp of last state change
 *
 * Use this context to persist user progress across page navigations.
 */
```

**server/middleware.ts:**

1. Add file-level comment:
```typescript
/**
 * Authentication Middleware
 *
 * Provides Express middleware for protecting API routes.
 * Uses JWT tokens stored in httpOnly cookies for session management.
 *
 * Available middleware:
 * - requireAuth: Ensures user is logged in
 * - requireAdmin: Ensures user is logged in AND is admin
 * - optionalAuth: Adds user to request if logged in, continues if not
 */
```

2. Add JSDoc to each middleware function:
- `requireAuth`: Validates JWT, attaches user to request, returns 401 if invalid
- `requireAdmin`: Same as requireAuth + checks isAdmin flag
- `optionalAuth`: Non-blocking auth check, useful for public routes that show different content to logged-in users
  </action>
  <verify>
    - AccessContext has file comment: `head -20 client/src/contexts/AccessContext.tsx | grep "Circle.so"`
    - SessionContext has file comment: `head -15 client/src/contexts/SessionContext.tsx | grep "SessionContext"`
    - middleware has file comment: `head -15 server/middleware.ts | grep "Authentication Middleware"`
    - Contains JSDoc markers: `grep -c "/\*\*" client/src/contexts/AccessContext.tsx` returns 2+
  </verify>
  <done>AccessContext, SessionContext, and middleware.ts have JSDoc comments explaining their purpose</done>
</task>

<task type="auto">
  <name>Task 2: Add JSDoc to storage and schema</name>
  <files>
    server/storage.ts
    shared/schema.ts
  </files>
  <action>
Add JSDoc comments to the following files. DO NOT rewrite - only ADD comments.

**server/storage.ts:**

1. Add file-level comment at top:
```typescript
/**
 * Storage Layer - Database Access Interface
 *
 * Provides a unified interface for all database operations.
 * Uses the Repository pattern to abstract Drizzle ORM queries.
 *
 * Two implementations:
 * - MemStorage: In-memory storage for testing (seeds default admin)
 * - DatabaseStorage: PostgreSQL via Drizzle ORM (production)
 *
 * Usage:
 *   import { storage } from './storage';
 *   const user = await storage.getUser(id);
 *
 * The active implementation is exported as `storage` singleton.
 */
```

2. Add JSDoc to IStorage interface methods (brief, one-line each):
- getUser: "Retrieves user by ID"
- getUserByEmail: "Retrieves user by email address"
- createUser: "Creates new user record"
- etc. (keep brief)

3. Add JSDoc to DatabaseStorage class:
```typescript
/**
 * PostgreSQL implementation of IStorage interface.
 * Uses Drizzle ORM for type-safe database queries.
 */
```

**shared/schema.ts:**

1. Add file-level comment at top:
```typescript
/**
 * Database Schema Definitions
 *
 * Defines all database tables using Drizzle ORM's pgTable.
 * Also exports Zod schemas for runtime validation.
 *
 * Tables:
 * - users: Authenticated users from Circle.so
 * - loginAttempts: Security audit log for login events
 * - appConfig: Application-wide settings (single row)
 * - paidMembers: Users who have paid for premium access
 * - feedbacks: User feedback submissions
 * - supportTickets: Support request tracking
 *
 * @see https://orm.drizzle.team/docs/sql-schema-declaration
 */
```

2. Add comments above each table (brief, explaining purpose):

```typescript
/**
 * Users table - Authenticated Circle.so members
 * Created when user first authenticates via Circle.so SSO
 */
export const users = pgTable("users", {

/**
 * Login attempts - Security audit log
 * Tracks successful and failed login attempts for rate limiting
 */
export const loginAttempts = pgTable("login_attempts", {

/**
 * App configuration - Application settings (singleton)
 * Single row with id='main' stores all app-wide settings
 */
export const appConfig = pgTable("app_config", {

/**
 * Paid members - Premium access list
 * Populated via webhook when user completes payment
 */
export const paidMembers = pgTable("paid_members", {

/**
 * Feedbacks - User feedback submissions
 * Stores ratings and improvement suggestions
 */
export const feedbacks = pgTable("feedbacks", {

/**
 * Support tickets - Help requests
 * Tracks support requests from new to resolved status
 */
export const supportTickets = pgTable("support_tickets", {
```
  </action>
  <verify>
    - storage.ts has file comment: `head -20 server/storage.ts | grep "Storage Layer"`
    - schema.ts has file comment: `head -20 shared/schema.ts | grep "Database Schema"`
    - schema.ts has table comments: `grep -c "Users table\|Login attempts\|App configuration" shared/schema.ts` returns 3
    - Contains JSDoc markers in storage: `grep -c "/\*\*" server/storage.ts` returns 3+
  </verify>
  <done>storage.ts and schema.ts have JSDoc comments explaining their structure and purpose</done>
</task>

</tasks>

<verification>
1. All 5 files have file-level JSDoc comments
2. Key functions/classes have JSDoc explaining their purpose
3. Schema tables have comments explaining what they store
4. Comments explain WHY, not just WHAT
5. Code still compiles: `npm run build` succeeds
</verification>

<success_criteria>
- AccessContext explains Circle.so postMessage flow
- middleware.ts explains each auth function
- schema.ts explains each table's purpose
- storage.ts explains the repository pattern
- All comments use proper JSDoc format (/** ... */)
- Build still succeeds after changes
</success_criteria>

<output>
After completion, create `.planning/phases/03-documentation-data/03-03-SUMMARY.md`
</output>
