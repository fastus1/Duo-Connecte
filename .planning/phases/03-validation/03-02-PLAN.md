---
phase: 03-validation
plan: 02
type: execute
wave: 2
depends_on: [03-01]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "App loads correctly inside Circle.so iframe"
    - "postMessage communication works between Circle.so and app"
    - "User email is extracted from Circle.so authentication message"
    - "Domain restriction layer blocks direct URL access when enabled"
    - "Login requirement layer blocks anonymous Circle.so users when enabled"
    - "Paywall layer blocks non-paid members when enabled"
    - "PIN layer requires PIN authentication when enabled"
  artifacts:
    - path: "Circle.so community page with embedded app"
      provides: "Iframe context for testing postMessage integration"
    - path: "Admin panel security tab"
      provides: "UI to toggle each security layer"
  key_links:
    - from: "Circle.so parent window"
      to: "App iframe"
      via: "postMessage with CIRCLE_USER_AUTH type"
      pattern: "type.*CIRCLE_USER_AUTH"
    - from: "AccessContext.tsx"
      to: "Circle.so origin"
      via: "origin validation"
      pattern: "communaute.avancersimplement.com"
---

<objective>
Verify Circle.so iframe integration and all 4 security layers on Railway deployment

Purpose: Confirm that the application works correctly when embedded in Circle.so (postMessage authentication) and that all security layers (domain, login, paywall, PIN) function as designed. This validates VAL-04 and VAL-05 requirements.

Output: Documented verification of iframe communication, origin validation, and each security layer with pass/fail status for each test case.
</objective>

<execution_context>
@/root/.claude/get-shit-done/workflows/execute-plan.md
@/root/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-validation/03-RESEARCH.md
@.planning/phases/03-validation/03-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Prepare security layer test environment</name>
  <files>None (verification only)</files>
  <action>
Before testing security layers, ensure admin can control all settings.

**Step 1: Verify current security configuration**
```bash
curl -s https://duo-connecte-production.up.railway.app/api/health | jq '.config'
```

Expected output shows 4 boolean flags:
- requireCircleDomain (Layer 1)
- requireCircleLogin (Layer 2)
- requirePaywall (Layer 3)
- requirePin (Layer 4)

**Step 2: Document initial state**
Record current settings before testing.

**Step 3: Ensure test paid member exists**
For paywall testing, we need a paid member in the database.
- If testing with a specific email, verify it's in paid_members via admin panel
- Or add a test email via Webhooks tab in admin panel

**Step 4: Verify CIRCLE_ORIGIN env var**
```bash
railway variables | grep CIRCLE_ORIGIN
```
Should show: https://communaute.avancersimplement.com

**Note for next task:** User must provide the Circle.so page URL where the app is embedded.
  </action>
  <verify>
Security layer config retrieved via API. Admin panel accessible to toggle settings. CIRCLE_ORIGIN correctly configured.
  </verify>
  <done>
Test environment ready: security settings visible, admin access confirmed, CIRCLE_ORIGIN matches production Circle.so community.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify Circle.so iframe integration (VAL-04)</name>
  <what-built>
App is configured to receive postMessage from Circle.so parent window with user authentication data. Origin validation restricts to https://communaute.avancersimplement.com.
  </what-built>
  <how-to-verify>
**IMPORTANT:** This test MUST be performed from within Circle.so, not via direct URL access.

**Pre-test: Disable domain restriction temporarily**
1. Go to https://duo-connecte-production.up.railway.app/admin
2. Security tab -> Disable "Exiger l'acces depuis Circle.so" (Layer 1)
3. This allows you to first confirm basic functionality

**Test 1: Basic iframe loading**
1. Navigate to the Circle.so community page where the app is embedded
   - URL: https://communaute.avancersimplement.com/[page-with-embed]
   - (You need to provide the exact page URL)
2. The app should load inside the Circle.so page iframe
3. No X-Frame-Options errors in browser console

**Test 2: postMessage communication**
1. While viewing the embedded app, open browser DevTools (F12)
2. Go to Console tab
3. Look for any logs related to Circle.so authentication
4. The app should receive user data from Circle.so:
   - User email
   - User name
   - publicUid
   - isAdmin flag
   - Theme (light/dark)

**Test 3: User recognition**
1. The app should show your Circle.so user info
2. You should not see "Acces depuis Circle.so requis" error
3. Your email should be recognized by the app

**Test 4: Theme sync**
1. If Circle.so uses dark mode, app should respect it
2. Toggle Circle.so theme and verify app updates

**Report findings:**
- Can the app load in the iframe?
- Is user data received from Circle.so?
- Any console errors related to postMessage or origin?
  </how-to-verify>
  <resume-signal>
Provide the Circle.so page URL and report: "iframe works" if postMessage communication succeeded, or describe issues (X-Frame errors, no user data, origin rejection).
  </resume-signal>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify all 4 security layers (VAL-05)</name>
  <what-built>
4-layer security system:
- Layer 1 (Domain): Blocks access unless from Circle.so iframe
- Layer 2 (Login): Requires Circle.so user to be logged in
- Layer 3 (Paywall): Requires email to be in paid_members table
- Layer 4 (PIN): Requires user to have/create PIN for session

Each layer is independently toggleable via admin panel.
  </what-built>
  <how-to-verify>
Test each security layer individually. Start with all layers DISABLED, then enable one at a time.

**Test Setup: Disable all layers**
1. Go to admin panel -> Security tab
2. Turn OFF all 4 toggles
3. Verify via API: curl /api/health shows all false

**Test Layer 1: Domain restriction (requireCircleDomain)**
1. Enable ONLY Layer 1 in admin panel
2. Test A - Direct access: Open https://duo-connecte-production.up.railway.app/ in new tab
   - Expected: "Acces non autorise" or similar error
3. Test B - Circle.so access: View app from Circle.so embed
   - Expected: App loads normally
4. Disable Layer 1 after testing

**Test Layer 2: Circle.so login (requireCircleLogin)**
1. Enable ONLY Layer 2 in admin panel
2. Test A - Access as logged-in Circle.so user (from your embed)
   - Expected: Access granted
3. Test B - Would need anonymous Circle.so visitor to fully test
   - Expected behavior: Anonymous users blocked
4. Disable Layer 2 after testing

**Test Layer 3: Paywall (requirePaywall)**
1. Ensure Layer 2 is ENABLED (Layer 3 requires it)
2. Enable Layer 3 in admin panel
3. Test A - Access with email NOT in paid_members
   - Expected: PaywallScreen shown ("Acces reserve aux membres payants")
4. Test B - Add your email to paid_members via admin panel
5. Test C - Access again with your email now in paid_members
   - Expected: Access granted
6. Disable Layers 2 and 3 after testing

**Test Layer 4: PIN requirement (requirePin)**
1. Enable Layer 4 in admin panel (can be tested with other layers off)
2. Test A - First access requires PIN creation
   - Expected: PIN creation form shown
3. Test B - Set PIN and access
   - Expected: PIN entry required on subsequent sessions
4. Test C - Wrong PIN should be rejected
   - Expected: Error message, not granted access
5. Disable Layer 4 after testing

**Final state:** Restore desired production security settings

**Report findings for each layer:**
- Layer 1: Direct access blocked? Iframe access works?
- Layer 2: Login required working?
- Layer 3: Paywall blocks non-paid? Allows paid?
- Layer 4: PIN creation works? PIN auth works?
  </how-to-verify>
  <resume-signal>
Report status for each layer: "Layer N: PASS" or "Layer N: FAIL - [reason]". Example: "Layer 1: PASS, Layer 2: PASS, Layer 3: PASS, Layer 4: PASS"
  </resume-signal>
</task>

</tasks>

<verification>
Phase 3 Plan 02 is complete when:
1. App loads correctly inside Circle.so iframe without X-Frame errors
2. postMessage from Circle.so is received with user authentication data
3. Layer 1 (Domain): Blocks direct URL access, allows iframe access
4. Layer 2 (Login): Requires authenticated Circle.so user
5. Layer 3 (Paywall): Blocks non-paid members, allows paid members
6. Layer 4 (PIN): Requires PIN creation/authentication
7. All layer toggles work correctly in admin panel
</verification>

<success_criteria>
- VAL-04: Circle.so iframe embedding works (postMessage communication, origin validation)
- VAL-05: All 4 security layers function correctly (domain check, user validation, paywall, PIN)
</success_criteria>

<output>
After completion, create `.planning/phases/03-validation/03-02-SUMMARY.md`
</output>
