---
phase: 01-code-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - vite.config.ts
  - package.json
  - server/app.ts
  - server/routes/support.ts
  - client/src/components/admin/WebhookTab.tsx
autonomous: true

must_haves:
  truths:
    - "npm run build succeeds without Replit plugins"
    - "npm run start works without REPLIT_* environment variables"
    - "No @replit/* package references remain in codebase"
    - "CORS configuration uses RAILWAY_PUBLIC_DOMAIN for production"
  artifacts:
    - path: "vite.config.ts"
      provides: "Clean Vite configuration without Replit plugins"
      not_contains: "@replit"
    - path: "package.json"
      provides: "Dependencies without Replit packages"
      not_contains: "@replit/vite-plugin"
    - path: "server/app.ts"
      provides: "Railway-compatible CORS configuration"
      contains: "RAILWAY_PUBLIC_DOMAIN"
      not_contains: "REPLIT_"
    - path: "server/routes/support.ts"
      provides: "Dynamic admin URL in email"
      contains: "APP_URL"
      not_contains: "replit.app"
  key_links:
    - from: "server/app.ts"
      to: "process.env.RAILWAY_PUBLIC_DOMAIN"
      via: "getAppOrigins function"
      pattern: "RAILWAY_PUBLIC_DOMAIN"
    - from: "server/routes/support.ts"
      to: "process.env.APP_URL"
      via: "email template"
      pattern: "APP_URL.*RAILWAY_PUBLIC_DOMAIN"
---

<objective>
Remove all Replit-specific dependencies and configuration from the codebase.

Purpose: Prepare the application for Railway deployment by removing Replit platform lock-in. The Replit Vite plugins, environment variables, and hardcoded URLs must be replaced with Railway-compatible alternatives.

Output: Clean codebase that builds and runs without any Replit-specific code, ready for Railway deployment.
</objective>

<execution_context>
@/root/.claude/get-shit-done/workflows/execute-plan.md
@/root/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-code-cleanup/01-RESEARCH.md

# Source files to modify
@vite.config.ts
@package.json
@server/app.ts
@server/routes/support.ts
@client/src/components/admin/WebhookTab.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove Replit Vite plugins and dependencies</name>
  <files>vite.config.ts, package.json</files>
  <action>
    In vite.config.ts:
    1. Remove the import: `import runtimeErrorOverlay from "@replit/vite-plugin-runtime-error-modal";`
    2. Remove `runtimeErrorOverlay()` from the plugins array
    3. Remove the entire conditional spread that loads @replit/vite-plugin-cartographer and @replit/vite-plugin-dev-banner (lines 10-20 with the REPL_ID check)
    4. Keep only `react()` in the plugins array

    Final plugins array should be simply:
    ```typescript
    plugins: [
      react(),
    ],
    ```

    In package.json:
    1. Remove these three devDependencies:
       - "@replit/vite-plugin-cartographer": "^0.4.4"
       - "@replit/vite-plugin-dev-banner": "^0.1.1"
       - "@replit/vite-plugin-runtime-error-modal": "^0.0.3"
    2. Do NOT modify any other dependencies
  </action>
  <verify>
    Run: `grep -r "@replit" vite.config.ts package.json`
    Expected: No output (no matches found)
  </verify>
  <done>vite.config.ts has no Replit imports or plugins, package.json has no @replit devDependencies</done>
</task>

<task type="auto">
  <name>Task 2: Update CORS and email URL configuration for Railway</name>
  <files>server/app.ts, server/routes/support.ts</files>
  <action>
    In server/app.ts:
    1. Update the comment on line 26 from "Replit's reverse proxy" to "Railway's reverse proxy"
    2. Update the comment on lines 35-36 to reflect Railway environment
    3. Replace the entire `getAppOrigins()` function (lines 37-58) with Railway-compatible version:

    ```typescript
    // Get app's own origin dynamically from Railway environment
    const getAppOrigins = (): string[] => {
      const origins: string[] = [];

      // Railway automatically provides RAILWAY_PUBLIC_DOMAIN
      if (process.env.RAILWAY_PUBLIC_DOMAIN) {
        origins.push(`https://${process.env.RAILWAY_PUBLIC_DOMAIN}`);
      }

      // Support custom domain via APP_DOMAIN env var
      if (process.env.APP_DOMAIN) {
        origins.push(process.env.APP_DOMAIN);
      }

      return origins;
    };
    ```

    In server/routes/support.ts:
    1. At line 41, replace the hardcoded URL `https://duo-connecte--fastusone.replit.app/admin` with a dynamic URL
    2. Add URL construction before the email HTML (around line 27, after ticket creation):
       `const appUrl = process.env.APP_URL || (process.env.RAILWAY_PUBLIC_DOMAIN ? \`https://${process.env.RAILWAY_PUBLIC_DOMAIN}\` : 'https://localhost:5000');`
    3. Replace the hardcoded href with `${appUrl}/admin`
  </action>
  <verify>
    Run: `grep -r "REPLIT_" server/`
    Expected: No output (no REPLIT references in server code)

    Run: `grep "RAILWAY_PUBLIC_DOMAIN" server/app.ts server/routes/support.ts`
    Expected: Both files contain RAILWAY_PUBLIC_DOMAIN references
  </verify>
  <done>server/app.ts uses RAILWAY_PUBLIC_DOMAIN for CORS, server/routes/support.ts uses dynamic URL for admin link</done>
</task>

<task type="auto">
  <name>Task 3: Clean up remaining Replit artifacts and reinstall</name>
  <files>client/src/components/admin/WebhookTab.tsx, .replit, replit.md</files>
  <action>
    In client/src/components/admin/WebhookTab.tsx:
    1. Line 113: Update the iframe selector from `'iframe[src*=".replit.app"]'` to `'iframe[src*=".railway.app"], iframe[src*=".up.railway.app"]'` (or make it more generic: `'iframe'`)
    2. Line 203: Update the placeholder from `"https://votre-app.replit.app"` to `"https://votre-app.railway.app"`

    Note: These are admin documentation/example code, not critical runtime code. The iframe selector is for admin testing purposes.

    Delete Replit configuration files:
    1. Delete `.replit` file
    2. Delete `replit.md` file

    Reinstall dependencies (clean install to remove @replit packages from node_modules):
    1. Run: `rm -rf node_modules`
    2. Run: `rm package-lock.json`
    3. Run: `npm install`

    Verify the build works:
    1. Run: `npm run build`
  </action>
  <verify>
    Run: `ls .replit replit.md 2>/dev/null || echo "Files deleted"`
    Expected: "Files deleted"

    Run: `grep -r "replit\.app" client/src/`
    Expected: No output (no hardcoded replit.app URLs)

    Run: `npm run build`
    Expected: Build completes successfully without errors
  </verify>
  <done>.replit and replit.md deleted, WebhookTab.tsx updated, dependencies reinstalled, build succeeds</done>
</task>

</tasks>

<verification>
After all tasks complete, run these verification commands:

1. **No Replit references in source code:**
   ```bash
   grep -r "@replit" --include="*.ts" --include="*.tsx" --include="*.json" . | grep -v node_modules | grep -v ".planning"
   ```
   Expected: No output

2. **No REPLIT environment variable references in server:**
   ```bash
   grep -r "REPLIT_" server/
   ```
   Expected: No output

3. **Build succeeds:**
   ```bash
   npm run build
   ```
   Expected: Exit code 0, no errors

4. **No Replit files remain:**
   ```bash
   ls .replit replit.md 2>&1
   ```
   Expected: "No such file or directory" for both

5. **Railway variables present in code:**
   ```bash
   grep "RAILWAY_PUBLIC_DOMAIN" server/app.ts server/routes/support.ts
   ```
   Expected: Both files contain RAILWAY_PUBLIC_DOMAIN
</verification>

<success_criteria>
- npm run build completes without errors
- No @replit/* packages in package.json
- No @replit imports in vite.config.ts
- No REPLIT_* environment variable references in server/ directory
- No hardcoded .replit.app URLs in source code
- .replit and replit.md files deleted
- CORS uses RAILWAY_PUBLIC_DOMAIN and APP_DOMAIN environment variables
- Email template uses dynamic APP_URL for admin link
</success_criteria>

<output>
After completion, create `.planning/phases/01-code-cleanup/01-01-SUMMARY.md`
</output>
