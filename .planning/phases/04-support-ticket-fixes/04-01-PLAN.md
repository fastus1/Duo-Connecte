---
phase: 04-support-ticket-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - client/src/components/admin/AdminSupportTickets.tsx
autonomous: false

user_setup:
  - service: resend
    why: "Email notifications for support tickets"
    env_vars:
      - name: RESEND_API_KEY
        source: "Resend Dashboard (resend.com) -> API Keys -> Create API Key"
    dashboard_config:
      - task: "Verify domain or use test mode"
        location: "Resend Dashboard -> Domains"

must_haves:
  truths:
    - "User submits a support ticket and it appears in admin dashboard"
    - "Admin receives email notification when a new ticket is created"
    - "Admin can view ticket details in the dashboard"
    - "Admin can send email reply to user from the dashboard"
  artifacts:
    - path: "client/src/components/admin/AdminSupportTickets.tsx"
      provides: "Admin ticket dashboard with correct API paths"
      contains: "/api/support/admin/tickets"
  key_links:
    - from: "client/src/components/admin/AdminSupportTickets.tsx"
      to: "/api/support/admin/tickets"
      via: "fetch calls"
      pattern: "fetch.*api/support/admin/tickets"
    - from: "server/routes/support.ts"
      to: "resend.emails.send"
      via: "Resend SDK"
      pattern: "resend\\.emails\\.send"
---

<objective>
Fix the support ticket system so admin can receive, view, and respond to tickets.

Purpose: The support ticket system is broken due to a route mismatch between frontend and backend API paths. Additionally, email notifications require RESEND_API_KEY to be configured in Railway.

Output: Working support ticket dashboard with email notifications.
</objective>

<execution_context>
@/root/.claude/get-shit-done/workflows/execute-plan.md
@/root/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md

# Key files
@client/src/components/admin/AdminSupportTickets.tsx
@server/routes/support.ts
@server/routes/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix API route paths in frontend</name>
  <files>client/src/components/admin/AdminSupportTickets.tsx</files>
  <action>
Update all API endpoint paths from `/api/admin/support/tickets` to `/api/support/admin/tickets`.

The backend routes are mounted as:
- `supportRouter` at `/api/support` (see server/routes/index.ts line 13)
- Routes inside support.ts are `/admin/tickets`, `/admin/tickets/:id/status`, etc.

So the correct paths are:
- GET `/api/support/admin/tickets` (list tickets)
- PATCH `/api/support/admin/tickets/:id/status` (update status)
- DELETE `/api/support/admin/tickets/:id` (delete ticket)
- POST `/api/support/admin/tickets/:id/reply` (send reply)

Find and replace all occurrences:
1. Line 30: queryKey from `/api/admin/support/tickets` to `/api/support/admin/tickets`
2. Line 33: fetch URL from `/api/admin/support/tickets` to `/api/support/admin/tickets`
3. Line 43: apiRequest path from `/api/admin/support/tickets/${id}/status` to `/api/support/admin/tickets/${id}/status`
4. Line 46: invalidateQueries key
5. Line 56: apiRequest path for DELETE
6. Line 59: invalidateQueries key
7. Line 69: apiRequest path for POST reply
8. Line 72: invalidateQueries key
  </action>
  <verify>
Run TypeScript check: `cd /home/yan/projets/Duo-Connecte && npm run check`
Verify the paths are correct by searching: `grep -n "api/support/admin/tickets" client/src/components/admin/AdminSupportTickets.tsx`
  </verify>
  <done>
All API calls in AdminSupportTickets.tsx use the correct path `/api/support/admin/tickets*` matching the backend routes.
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: Configure RESEND_API_KEY in Railway</name>
  <action>
The email notification code already exists in server/routes/support.ts but needs the RESEND_API_KEY environment variable to be set.
  </action>
  <instructions>
1. Go to https://resend.com and sign in (or create account)
2. Navigate to API Keys section
3. Create a new API key (name it "duo-connecte-production")
4. Copy the API key
5. Go to Railway dashboard -> duo-connecte project -> Variables
6. Add: RESEND_API_KEY = (paste the key)
7. Railway will auto-redeploy

Note: If you haven't verified a domain, Resend will work in test mode (can only send to your own email).
  </instructions>
  <resume-signal>Type "done" when RESEND_API_KEY is configured in Railway, or "skip" to continue without email (dashboard will still work)</resume-signal>
</task>

</tasks>

<verification>
After both tasks complete:

1. **Dashboard loads tickets**: Visit https://duo-connecte-production.up.railway.app/admin and check the Support section loads without errors

2. **Create test ticket**: Submit a support ticket through the app:
   - Go to the support/contact section
   - Fill in name, email, subject, description
   - Submit

3. **Verify ticket appears**: Refresh admin dashboard and confirm the new ticket appears

4. **Test email notification** (if RESEND_API_KEY configured): Check admin email for notification

5. **Test reply**: Click reply on a ticket, write a message, send - verify email is received
</verification>

<success_criteria>
- [ ] Admin dashboard at /admin loads tickets without 404 errors
- [ ] New support tickets appear in the dashboard
- [ ] Admin can change ticket status
- [ ] Admin can delete tickets
- [ ] Admin can send email replies (requires RESEND_API_KEY)
- [ ] Email notifications sent when tickets created (requires RESEND_API_KEY)
</success_criteria>

<output>
After completion, create `.planning/phases/04-support-ticket-fixes/04-01-SUMMARY.md`
</output>
